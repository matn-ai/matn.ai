{% block dashboard %}
<div class="row">
    <div class="col-4">
        <div class="bg-white rounded p-4 card-shadow">
            <div class="p-4 pt-0">
                <h4>حالت ساده</h4>
            </div>
            <form id="submission_form" class="form-group mb-4 mt-2" hx-post="{{url_for('dashboard.article_blog')}}"
                hx-target="#text-editor" hx-swap="innerHTML">
                {{ form.hidden_tag() }}
                <div class="form-group mb-4 mt-2">
                    <label for="user_topic" class="mb-2">{{ form.user_topic.label }}</label>
                    {{ form.user_topic(size=32, class_="form-control") }}
                </div>
                <div class="form-group mb-4 mt-2 pb-4">
                    <label for="lang" class="mb-2">{{ form.lang.label }}</label>
                    {{ form.lang(class_="form-control") }}
                </div>
                <div class="form-group mb-4 mt-2 pb-4">
                    <label for="tags" class="mb-2">{{ form.tags.label }}</label>
                    {{ form.tags(size=40, id="tags-input", class="form-control") }}
                </div>
                <div class="form-group text-right mt-4">
                    {{ form.submit(class_="btn btn-primary text-white w-50") }}
                </div>
            </form>
        </div>
    </div>
    <div class="col-8">
        

        <div class="rounded card-shadow">

            <div id="loading-content" style="display: none; height: 500px;" class="text-center mr-auto mx-auto">
                <lottie-player   src="{{ url_for('static', filename='media/content-create.json') }}" background="transparent"  speed="1"   loop autoplay></lottie-player>
            </div>

            <div id="text-editor-area">
                <textarea id="text-editor"></textarea>

            </div>
        </div>
    </div>
</div>

<!-- Include TinyMCE Scripts -->
<script src="https://cdn.tiny.cloud/1/mcpuwvw769rgh14psm3l20vlt83rf7wegybfpi9vzo5z0ld9/tinymce/5/tinymce.min.js" referrerpolicy="origin"></script>
<script>
    tinymce.init({
        selector: '#text-editor',
        height: 500,
        menubar: false,
        plugins: [
            'directionality'
        ],
        directionality: 'rtl',
        toolbar: 'ltr rtl | undo redo | formatselect | bold italic backcolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent',
        content_css: '/static/css/editor.css',
        importcss_append: true
    });
    //tinymce.activeEditor.execCommand('mceDirectionRTL');
    
    var input = document.getElementById('tags-input');
    new Tagify(input);


    // Polling function to check job status
    function checkJobStatus(jobId, contentId) {
        $.get(`/dashboard/article/blog/status/${jobId}`, function (data) {
            if (data.status === 'SUCCESS') {
                // Fetch the generated content if job is successful
                fetchContent(contentId);
            } else {
                // Retry after 2 seconds if job is still pending
                setTimeout(() => checkJobStatus(jobId, contentId), 2000);
            }
        });
    }

    // Function to retrieve the generated content
    function fetchContent(contentId) {

        $.get(`/dashboard/article/blog/content/${contentId}`, function (data) {
            $('#text-editor-area').show()
            $('#loading-content').hide()    
            tinymce.get('text-editor').setContent(data.content);
        });
    }

    $(document).on('htmx:afterOnLoad', function (evt) {
        // Extract job ID and content ID from hidden inputs
        const jobId = $('#job-id').val();
        const contentId = $('#content-id').val();
        $('#text-editor-area').hide()
        $('#loading-content').show()

        // Start polling the job status
        checkJobStatus(jobId, contentId);
    });
</script>
{% endblock %}