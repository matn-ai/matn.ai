{% extends "dashboard/dashboard.html" %}
{% block dashboard %}
<style>
    .wizard.vertical .wizard-nav {
        padding-right: 0px;
    }

    .wizard.vertical .wizard-content {
        min-height: 660px;
    }

    .is-invalid {
        border-color: red !important;
    }
</style>
<div class="row">
    <div class="col-12 mr-auto mx-auto">
        <div class="d-flex">
            <div class="p-2 ">
                <h4 class="">تولید مقاله حرفه‌ای</h4>
            </div>
            <div class="p-2 ms-auto">
                <!-- <span
                    class="d-inline-flex mb-3 px-2 py-1 fw-semibold text-primary-emphasis bg-primary-subtle border border-primary-subtle rounded-2">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="flexSwitchCheckDefault">
                        <label class="form-check-label" for="flexSwitchCheckDefault">نسخه پلاس</label>
                    </div>
                </span> -->
            </div>
            <div class="p-2">
                <span
                    class="d-inline-flex mb-3 px-2 py-1 fw-semibold text-primary-emphasis bg-primary-subtle border border-primary-subtle rounded-2">زمان
                    تقریبی ۴ تا ۶ دقیقه</span>
            </div>
            <div class="p-2" id="article-container-timer" style="display: none;">
                <span
                    class="d-inline-flex mb-3 px-2 py-1 fw-semibold text-primary-emphasis bg-primary-subtle border border-primary-subtle rounded-2"
                    id="article-info-timer">
                </span>
            </div>
        </div>
        <div class="bg-white rounded p-4 card-shadow" id="form-container">
            <div class="d-flex justify-content-between mb-4 w-100"></div>
            <form class="wizard" id="formWizard" class="p-2">
                <aside class="wizard-content container border p-4 mb-4 rounded">
                    <div class="wizard-step" data-title="تنظیمات مقاله">
                        <form id="form-step1" class="form-group mb-4 mt-4" method="post">
                            {{ form.hidden_tag() }}
                            <div class="form-group mb-4 mt-2">
                                <label for="user_topic" class="mb-2">{{ form.user_topic.label }}</label>
                                {{ form.user_topic(id="form_user_topic", size=500, class_="form-control",
                                style="max-height: 100px;") }}
                                <div id="user_topic_error" class="form-text text-danger"></div>
                                <div class="form-text">عنوان یا شرح موضوع مقاله را وارد کنید.</div>
                            </div>
                            <div class="form-group mb-4 mt-2 pb-4">
                                <label for="tags" class="mb-2">{{ form.main_tag.label }}</label>
                                {{ form.main_tag(id="main-tag-input", class="form-control") }}
                                <div id="main_tag_error" class="form-text text-danger"></div>
                                <div class="form-text">پس از وارد کردن هر کلمه Enter بزنید.</div>
                            </div>
                            <div class="form-group mb-4 mt-2 pb-4">
                                <label for="tags" class="mb-2">{{ form.tags.label }}</label>
                                {{ form.tags(id="tags-input", class="form-control") }}
                                <div class="form-text">پس از وارد کردن هر کلمه Enter بزنید.</div>
                            </div>
                            <div class="row mb-4">
                                <div class="col-6">
                                    <div class="form-floating">
                                        {{ form.point_ofview(class="form-select", id="point_ofview") }}
                                        <label for="floatingSelectTone">{{ form.point_ofview.label }}</label>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="form-floating">
                                        {{ form.target_audience(class="form-select", id="target_audience") }}
                                        <label for="floatingSelectTone">{{ form.target_audience.label }}</label>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-6">
                                    <div class="form-floating">
                                        {{ form.voice_tune(class="form-select", id="voice_tune") }}
                                        <label for="floatingSelectTone">{{ form.voice_tune.label }}</label>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="form-floating">
                                        {{ form.article_length(class="form-select", id="article_length") }}
                                        <label for="floatingSelectTone">{{ form.article_length.label }}</label>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group mb-4 mt-4">
                                <div class="w-100 p-3 text-right">زبان نوشتار را انتخاب کنید</div>
                                <div class="w-100 p-3 text-center">
                                    <input type="radio" class="btn-check" value="fa" name="language" id="fa-outlined"
                                        autocomplete="off" checked>
                                    <label class="btn btn-outline-primary" for="fa-outlined">
                                        <span class="fi fi-ir me-1"></span>فارسی
                                    </label>
                                    <input type="radio" class="btn-check" value="en" name="language" id="en-outlined"
                                        autocomplete="off">
                                    <label class="btn btn-outline-primary" for="en-outlined">
                                        <span class="fi fi-us me-1"></span>English
                                    </label>
                                    <!-- <input type="radio" class="btn-check" value="ar" name="language" id="ar-outlined"
                                        autocomplete="off">
                                    <label class="btn btn-outline-primary" for="ar-outlined">
                                        <span class="fi fi-ae me-1"></span>عربى
                                    </label>
                                    <input type="radio" class="btn-check" value="fr" name="language" id="fr-outlined"
                                        autocomplete="off">
                                    <label class="btn btn-outline-primary" for="fr-outlined">
                                        <span class="fi fi-fr me-1"></span>Français
                                    </label> -->
                                </div>
                            </div>
                            <div class="form-group mb-4 mt-4">
                                <div class="w-100 p-3 text-right">مدل زبانی را انتخاب کنید</div>
                                <div class="w-100 p-3">
                                    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                                        <div class="col">
                                            <div class="card h-100">
                                                <div class="card-body">
                                                    <input type="radio" class="btn-check" value="gpt-4o"
                                                        name="language_model" id="gpt4-outlined" autocomplete="off"
                                                        checked>
                                                    <label class="btn btn-outline-primary w-100 h-100"
                                                        for="gpt4-outlined">
                                                        <img src="/static/images/logo-gpt4.jpeg" alt="OpenAI"
                                                            class="mb-3 rounded" style="height: 72px;">
                                                        <h5 class="card-title">OpenAI GPT-4o</h5>
                                                        <p class="card-text">ضریب کلمه: ۵</p>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col">
                                            <div class="card h-100">
                                                <div class="card-body">
                                                    <input type="radio" class="btn-check" value="gpt-3.5-turbo"
                                                        name="language_model" id="gpt3.5-outlined" autocomplete="off">
                                                    <label class="btn btn-outline-primary w-100 h-100"
                                                        for="gpt3.5-outlined">
                                                        <img src="/static/images/logo-gpt3.5.jpeg" alt="OpenAI"
                                                            class="mb-3 rounded" style="height: 72px;">
                                                        <h5 class="card-title">OpenAI GPT-3.5</h5>
                                                        <p class="card-text">ضریب کلمه: ۱</p>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col">
                                            <div class="card h-100">
                                                <div class="card-body">
                                                    <input type="radio" class="btn-check" value="gemini-pro-1.5"
                                                        name="language_model" id="gemini-pro-outlined"
                                                        autocomplete="off">
                                                    <label class="btn btn-outline-primary w-100 h-100"
                                                        for="gemini-pro-outlined">
                                                        <img src="/static/images/logo-gemini.jpeg" alt="Gemini"
                                                            class="mb-3 rounded" style="height: 72px;">
                                                        <h5 class="card-title">Gemini Pro 1.5</h5>
                                                        <p class="card-text">ضریب کلمه: ۳</p>
                                                    </label>
                                                </div>
                                            </div>
                                        </div> 
                                        <div class="col">
                                            <div class="card h-100">
                                                <div class="card-body">
                                                    <input type="radio" class="btn-check" value="claude-3-haiku"
                                                        name="language_model" id="claude3-haiku-outlined"
                                                        autocomplete="off">
                                                    <label class="btn btn-outline-primary w-100 h-100"
                                                        for="claude3-haiku-outlined">
                                                        <img src="/static/images/logo-claude.jpeg" alt="Haiku"
                                                            class="mb-3 rounded" style="height: 72px;">
                                                        <h5 class="card-title">Claude 3 Haiku</h5>
                                                        <p class="card-text">ضریب کلمه: ۱</p>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col">
                                            <div class="card h-100">
                                                <div class="card-body">
                                                    <input type="radio" class="btn-check" value="claude-3.5-sonnet"
                                                        name="language_model" id="claude3.5-sonnet-outlined"
                                                        autocomplete="off">
                                                    <label class="btn btn-outline-primary w-100 h-100"
                                                        for="claude3.5-sonnet-outlined">
                                                        <img src="/static/images/logo-claude.jpeg" alt="Sonnet"
                                                            class="mb-3 rounded" style="height: 72px;">
                                                        <h5 class="card-title">Claude 3.5 Sonnet</h5>
                                                        <p class="card-text">ضریب کلمه: ۴</p>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                            </div>

                        </form>
                    </div>
                    <div class="wizard-step" data-title="لینک و فایل">
                        <div class="row">
                            <div class="col-11 mr-auto mx-auto">
                                <div class="w-100 p-2 mb-2 mt-2 text-primary-emphasis">
                                    حداکثر ۵ منبع می‌توانید انتخاب کنید
                                </div>
                                <div id="selected-resources">
                                    <!-- Selected resources will be appended here -->
                                </div>
                                <div class="d-flex justify-content-end mt-3">
                                    <input type="file" id="file-upload" class="d-none" />
                                    <button class="btn btn-primary" id="upload-button">
                                        <i class="fa-solid fa-upload me-2"></i>
                                        <span>آپلود فایل</span>
                                        <span class="spinner-border spinner-border-sm d-none" role="status"
                                            aria-hidden="true"></span>
                                    </button>
                                </div>
                            </div>
                            <div class="col-11 mr-auto mx-auto mt-4 pt-4">
                                <div class="form-group">
                                    <label for="search_in_resource" class="mb-3">جستجو در منابع</label>
                                    <div class="input-group mb-3">
                                        <input type="text" class="form-control" placeholder="جستجو در منابع"
                                            name="search_in_resource" aria-label="جستجو"
                                            aria-describedby="button-addon2">
                                        <button class="btn btn-outline-secondary" type="button"
                                            id="search-resource-btn">
                                            <i class="fa-solid fa-magnifying-glass"></i>
                                        </button>
                                    </div>
                                </div>

                                <div class="loading text-center" style="height: 650px;" id="loading-resources">
                                    <div class="spinner-border text-primary" role="status"
                                        style="margin-top: 40%;width: 3rem; height: 3rem;">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <div class="loading-text">در حال دریافت منابع...</div>
                                </div>

                                <div class="list-group mt-3" style="overflow-y: auto; height: 650px;"
                                    id="resource-result">

                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="wizard-step" data-title="انتخاب تیتر">
                        <div class="d-flex justify-content-between mb-4">
                            <div class="p-2 mb-2 mt-2 text-primary-emphasis">
                                یکی از تیتر های پیشنهادی برای نوشتار را انتخاب کنید
                            </div>
                            <button class="btn btn-link" id="refresh-suggest-titles" type="button">
                                <i class="fa-solid fa-arrows-rotate me-2"></i>
                            </button>
                        </div>
                        <div class="loading text-center" style="height: 650px;" id="loading-titles">
                            <div class="spinner-border text-primary" role="status"
                                style="margin-top: 40%;width: 3rem; height: 3rem;">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <div class="loading-text">در حال دریافت تیترها...</div>
                        </div>

                        <ul class="p-3 rounded list-group" id="titles-container">
                            <ul id="suggest-titles" class="list-group">

                            </ul>

                            <li class="list-group-item mt-2 mb-2 p-2 text-bg-light rounded" id="titles-user-input">
                                <div class="d-flex align-items-center">
                                    <input class="form-check-input me-1" type="radio" name="listGroupRadio"
                                        id="titles-user-input-radio">
                                    <input type="text" minlength="10" class="form-control me-2" id="user-title-input"
                                        placeholder="عنوان دلخواه خود را وارد کنید">
                                </div>
                            </li>
                        </ul>

                    </div>
                    <div class="wizard-step" data-title="انتخاب عناوین">
                        <div class="w-100 p-2 mb-2 mt-2 text-primary-emphasis">
                            یکی از لیست‌‌های عناوین پیشنهادی برای نوشتار را انتخاب کنید:
                        </div>
                        <div class="loading text-center" style="height: 650px;" id="loading-outlines">
                            <div class="spinner-border text-primary" role="status"
                                style="margin-top: 40%;width: 3rem; height: 3rem;">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <div class="loading-text">در حال دریافت عناوین...</div>
                        </div>
                        <div id="outlines-container" style="display: none;">
                            <ul class="nav nav-tabs" id="outlineTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="tab-1-tab" data-bs-toggle="tab"
                                        data-bs-target="#tab-1" type="button" role="tab" aria-controls="tab-1"
                                        aria-selected="true">لیست ۱</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="tab-2-tab" data-bs-toggle="tab" data-bs-target="#tab-2"
                                        type="button" role="tab" aria-controls="tab-2" aria-selected="false">لیست
                                        ۲</button>
                                </li>
                            </ul>
                            <div class="tab-content" id="outlineTabsContent">
                                <div class="tab-pane fade show active" id="tab-1" role="tabpanel"
                                    aria-labelledby="tab-1-tab">
                                    <div id="list-1" class="p-3 mt-2"></div>
                                    <div class="w-100 text-center">
                                        <button class="btn btn-light add-main-outline-btn" data-list="1" type="button">
                                            <i class="fas fa-plus"></i> افزودن عنوان
                                        </button>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="tab-2" role="tabpanel" aria-labelledby="tab-2-tab">
                                    <div id="list-2" class="p-3 mt-2"></div>
                                    <div class="w-100 text-center">
                                        <button class="btn btn-light add-main-outline-btn" data-list="2" type="button">
                                            <i class="fas fa-plus"></i> افزودن عنوان
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="wizard-step" data-title="انتخاب عکس">
                        <div class="w-100 p-2 mb-2 mt-2 text-primary-emphasis">
                            عکس متناسب با نوشتار را انتخاب کنید.
                        </div>
                        <div class="loading text-center" style="height: 650px;" id="loading-images">
                            <div class="spinner-border text-primary" role="status"
                                style="margin-top: 40%;width: 3rem; height: 3rem;">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <div class="loading-text">در حال دریافت تصاویر...</div>
                        </div>
                        <div class="loading text-center" style="height: 650px;" id="loading-images">
                            <div class="spinner-border text-primary" role="status"
                                style="margin-top: 40%;width: 3rem; height: 3rem;">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <div class="loading-text">در حال دریافت منابع...</div>
                        </div>

                        <div id="images-container">

                        </div>
                    </div>
                </aside>
            </form>
        </div>
        <div class="bg-white rounded p-4 card-shadow" id="content-container"
            style="display: none; position: relative; height: 100%">
            <div id="loading-content" class="text-center mr-auto mx-auto"
                style="display: none;  height: 100%; width: 100%; position: absolute; background-color: rgba(255, 255, 255, 0.8); z-index: 100;">
                <div style="width: 320px;" class="mr-auto mx-auto position-absolute top-50 start-50 translate-middle">
                    <lottie-player src="{{ url_for('static', filename='media/content-create.json') }}"
                        background="transparent" speed="1" loop autoplay></lottie-player>
                </div>
                <div class="loading-text">در حال ایجاد محتوا...</div>
            </div>
            <div id="text-editor-area">
                {{ form.body(id="text-editor", class="form-control") }}
            </div>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/jquery.js') }}"></script>
<script src="{{ url_for('static', filename='js/tagify.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/ckeditor.js') }}"></script>
<script src="{{ url_for('static', filename='js/wizard.min.js') }}"></script>

<script>
    $(document).ready(function () {
        let maxSelectedResources = 5;
        let resources = [];
        let suggested_lists = [];
        let selected_list = null;
        let selectedTitle = "";
        let mainOutlineCounter = 0;
        let subOutlineCounter = 0;

        function startTimer(startDate = null) {
            var start = startDate ? new Date(startDate) : new Date();

            setInterval(function () {
                var now = new Date();
                var elapsed = Math.floor((now - start) / 1000);
                var hours = Math.floor(elapsed / 3600);
                var minutes = Math.floor((elapsed % 3600) / 60);
                var seconds = elapsed % 60;

                function pad(number) {
                    return number < 10 ? '0' + number : number;
                }

                function toPersianNumber(number) {
                    var persianMap = {
                        '0': '۰', '1': '۱', '2': '۲', '3': '۳', '4': '۴',
                        '5': '۵', '6': '۶', '7': '۷', '8': '۸', '9': '۹'
                    };
                    return number.toString().split('').map(char => persianMap[char] || char).join('');
                }

                var time = `${toPersianNumber(pad(minutes))}:${toPersianNumber(pad(seconds))}`
                $("#article-info-timer").html(time);
            }, 1000);
        }

        function checkJobStatus(jobId, contentId) {
            $.get(`/dashboard/article/blog/status/cid/${jobId}`, function (data) {
                if (data.status === 'SUCCESS') {
                    $('#article-info-timer').html(data.running_duration);
                    fetchContent(contentId);
                } else if (data.status === 'FAILURE') {
                    $('#loading-content').hide();
                    tagify.setReadonly(false);
                } else {
                    setTimeout(() => checkJobStatus(jobId, contentId), 2000);
                }
            });
        }

        function fetchContent(contentId) {
            $.get(`/dashboard/article/blog/content/${contentId}`, function (data) {
                $('#loading-content').hide();
                editor.setData(data.content);
            });
        }

        function updateResourceCount() {
            let selectedCount = $("#selected-resources .row").length;
            let remaining = maxSelectedResources - selectedCount;
            $("#resource-result .add-resource").toggle(remaining > 0);
        }

        function addResource(key, type, url) {
            if ($("#selected-resources .row").length >= maxSelectedResources) {
                alert('You can select up to ' + maxSelectedResources + ' resources only.');
                return;
            }

            let badgeClass = type === 'file' ? 'text-bg-secondary' : 'text-bg-primary';
            let selectedRow = `<div class="row p-1 rounded border mt-2" id="${key}-selected">
                <div class="col-3 p-2 text-right">
                    <i class="fa-solid fa-circle-minus text-danger remove-resource"></i>
                    <i class="fa-solid fa-pen-to-square text-primary"></i>
                </div>
                <div class="col-9 p-2" style="direction: ltr; text-align: left;">
                    <span class="badge ${badgeClass} ms-2">${type === 'file' ? 'فایل' : 'وب'}</span>
                    <a class="link-primary" href="${url}" >${url}</a>
                </div>
            </div>`;
            $("#selected-resources").append(selectedRow);

            // Add remove event listener
            $(".remove-resource").off('click').on("click", function () {
                let selectedResource = $(this).closest(".row");
                selectedResource.remove();
                updateResourceCount();
            });

            updateResourceCount();
        }

        let args = {
            wz_class: ".wizard",
            wz_nav_style: "dots",
            wz_ori: "vertical",
            buttons: true,
            navigation: "buttons",
            next: "بعدی",
            prev: "قبلی",
            finish: "نوشتن را شروع کن",
            wz_button: ".m-2",
            wz_next: ".btn-outline-primary",
            wz_prev: ".btn-outline-dark",
            wz_finish: ".finish-button"
        };

        const wizard = new Wizard(args);
        wizard.init();

        let input = document.getElementById('tags-input');
        let tagify = new Tagify(input, { maxTags: 5 });

        let main_tag = document.getElementById('main-tag-input');
        let main_tagify = new Tagify(main_tag, { maxTags: 1, required: true });

        let $wz_doc = document.querySelector(".wizard");

        $wz_doc.addEventListener("wz.btn.next", function (e) {
            if (wizard.current_step === 0) {
                $(".loading").hide()
                if (validateFirstStep()) {
                    $("input[name='search_in_resource']").prop('disabled', true)
                    $("#search-resource-btn").prop('disabled', true)

                    wizard.lock();
                    loadResources(false);
                    wizard.unlock();
                } else {
                    e.preventDefault();  // Prevent from proceeding if validation fails
                }
            } else if (wizard.current_step === 1) {
                wizard.lock();
                loadTitles();
                wizard.unlock();
            } else if (wizard.current_step === 2) {
                if (validateSecondStep()) {
                    wizard.lock();
                    loadOutlines();
                    wizard.unlock();
                } else {
                    e.preventDefault();  // Prevent from proceeding if validation fails
                }
            }
            else if (wizard.current_step === 3) {
                wizard.lock();
                $("#images-container").empty()
                $("#images-container").hide()
                showLoader('#loading-images', [
                    'در حال بارگذاری تصاویر...',
                    'در حال یافتن بهترین تصاویر مرتبط...',
                    'لطفا صبور باشید، تصاویر بیشتر در راهند...',
                    'در حال دریافت اطلاعات تصاویر...',
                    'در حال پردازش تصاویر...'
                ]);
                $("#form-container").find("input, button, textarea, select").prop("disabled", false);
                $('.btn-outline-primary').hide();
                $('.btn-outline-dark').hide();
                $('.finish-button').css("display: none");
                loadBtnLoader()

                // Modify the function to integrate the click event for replacing the image
                function loadImageForOutline(outline, outlineIndex) {
                    return new Promise((resolve, reject) => {
                        let mainOutlineCounter = outlineIndex + 1;
                        let mainOutlineId = `image-${mainOutlineCounter}`;
                        let mainHead = outline.head;

                        $.ajax({
                            type: 'POST',
                            url: "{{ url_for('dashboard.get_images') }}",  // Replace with correct endpoint
                            data: JSON.stringify({ title: mainHead }),
                            contentType: "application/json",
                            processData: false,
                            success: function (response) {
                                let image = response[0].img_src;
                                selected_list[outlineIndex]['image'] = image

                                let outlineHTML = `<div class="mb-3 outline-item" id="image-${mainOutlineId}">
                    <div class="d-flex mb-2">
                        <div class="row">
                            <div class="col-12">
                                <input type="text" class="form-control main-outline-input bg-white border-0 fs-5" disabled id="${mainOutlineId}-input" value="${mainHead}" />    
                            </div>
                            <div class="col-12"> 
                                <img src="${image}" class="img-thumbnail rounded ratio ratio-1x1 mx-auto d-block mt-3 mb-3 outline-image" id="img-${mainOutlineId}" />
                            </div>
                        </div>
                        <button type="button" class="btn btn-link text-primary fs-5 ms-2 add-image" data-bs-toggle="offcanvas" data-bs-target="#offcanvasBottom-${mainOutlineCounter}" aria-controls="offcanvasBottom-${mainOutlineCounter}" title="${mainHead}">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </button>
                        <button type="button" class="btn btn-link text-secondary fs-5 ms-2 remove-image" data-main-outline-id="${mainOutlineId}">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>

                    <div class="offcanvas  offcanvas-start" tabindex="-1" data-bs-scroll="true" data-bs-backdrop="false" id="offcanvasBottom-${mainOutlineCounter}" aria-labelledby="offcanvasBottomLabel-${mainOutlineCounter}">
                        <div class="offcanvas-header">
                            <div class="offcanvas-title" id="offcanvasBottomLabel-${mainOutlineCounter}"> جستجو در تصاویر</div>
                            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                        </div>
                        <div class="offcanvas-body small image-search-container text-center p-2" id="image-search-container-${mainOutlineCounter}">
                            در حال بارگزاری موتور جستجو...
                        </div>
                    </div>
                </div>`;

                                $('#images-container').append(outlineHTML);

                                // Event listener to load images when the offcanvas is shown
                                $(`#offcanvasBottom-${mainOutlineCounter}`).on('show.bs.offcanvas', function () {
                                    const containerId = `#image-search-container-${mainOutlineCounter}`;
                                    $(`#offcanvasBottomLabel-${mainOutlineCounter}`).html(`<span class="badge text-bg-secondary small">جستجو برای</span> <div class="p-3 text-primary mb-4 mt-2 fw-bold">${mainHead}</div>`)
                                    loadImageSearch(containerId, mainHead, mainOutlineCounter);
                                });

                                resolve();  // Resolve the promise
                            },
                            error: function (error) {
                                console.log('Error:', error);
                                reject(error);  // Reject the promise
                            }
                        });
                    });
                }

                // Function to load images in the search container and handle image click
                function loadImageSearch(containerId, mainHead, id) {
                    $.ajax({
                        type: 'POST',
                        url: "{{ url_for('dashboard.search_images') }}",  // Replace with correct endpoint
                        data: JSON.stringify({ title: mainHead }),
                        contentType: "application/json",
                        processData: false,
                        success: function (response) {
                            $(containerId).empty();
                            $.each(response, function (index, imageDetails) {
                                console.log(imageDetails)
                                if (imageDetails && imageDetails.img_src && imageDetails.source) {
                                    const imageHTML = `<div class="image-result card mb-4 p-3" data-image-src="${imageDetails.img_src}" data-main-outline-id="image-${id}">
                                        <img src="${imageDetails.thumbnail_src}" alt="${imageDetails.title}" class="img-thumbnail ratio ratio-1x1 image-result-item "">
                                        <div class="w-100 mt-2">
                                            <span class="badge text-bg-light"> منبع ${imageDetails.source}</span>
                                            <span class="badge text-bg-light"> موتور ${imageDetails.engine}</span>
                                            <span class="badge text-bg-light"><a class="text-bg-primary" href="${imageDetails.url}" target=_blank><i class="fa-solid fa-arrow-up-right-from-square"></i></a></span>
                                        <div class="w-100 text-secondary p-2 mt-3" style='text-align: right;'>
                                            ${imageDetails.title}
                                        </div>
                                    </div>`;
                                    $(containerId).append(imageHTML);

                                }
                            });

                            $(containerId).find('.image-result').on('click', function () {
                                const imageUrl = $(this).data('image-src');
                                selected_list[id]['image'] = imageUrl
                                console.log(selected_list)
                                $(`#img-image-${id}`).attr('src', imageUrl);
                            });
                        },
                        error: function (error) {
                            console.log('Error:', error);
                        }
                    });
                }
                // Sequentially load images for each outline
                (async function loadAllImages() {
                    for (let outlineIndex = 0; outlineIndex < selected_list.length; outlineIndex++) {
                        try {
                            if (outlineIndex == 0)
                                continue
                            if (outlineIndex == selected_list.length)
                                continue
                            else
                                await loadImageForOutline(selected_list[outlineIndex], outlineIndex);
                        } catch (error) {
                            // Handle the error case if needed
                        }
                    }
                    $('.btn-outline-primary').show();
                    $('.btn-outline-dark').show();
                    $('#btn-spinner').remove();
                    $("#images-container").show()
                    $("#loading-images").hide()
                    $('.finish-button').show();

                    wizard.unlock();
                })();

            }
        });

        $('#images-container').on('click', '.remove-image', function () {
            const mainOutlineId = $(this).data('main-outline-id');
            $(`#img-${mainOutlineId}`).attr('src', '/static/images/no-image.jpeg');
        });

        function validateSecondStep() {
            // Get all the suggested titles radio inputs
            const suggestedTitles = document.querySelectorAll('#suggest-titles input[type="radio"]');
            // Get the user input radio and text input
            const userInputRadio = document.getElementById('titles-user-input-radio');
            const userInput = document.getElementById('user-title-input');

            // Check if any suggested title is selected
            for (let i = 0; i < suggestedTitles.length; i++) {
                if (suggestedTitles[i].checked) {
                    return true;
                }
            }

            // Check if user input radio is selected
            if (userInputRadio.checked) {
                // Check if the user input text length is more than 5 characters
                if (userInput.value.length > 5) {
                    return true;
                } else {
                    return false;
                }
            }

            // If neither suggested titles nor valid user input is selected
            return false;

        }

        function validateFirstStep() {
            let isValid = true;

            const userTopicField = document.getElementById('form_user_topic');
            const userTopicError = document.getElementById('user_topic_error');
            const mainTagField = document.getElementById('main-tag-input');
            const mainTagError = document.getElementById('main_tag_error');

            userTopicField.classList.remove('is-invalid');
            userTopicError.textContent = '';
            mainTagField.classList.remove('is-invalid');
            mainTagError.textContent = '';

            if (!userTopicField.value.trim()) {
                isValid = false;
                userTopicField.classList.add('is-invalid');
                userTopicError.textContent = 'عنوان مقاله خالی است.';
            }

            if (main_tagify.value.length !== 1) {
                isValid = false;
                mainTagField.classList.add('is-invalid');
                mainTagError.textContent = 'کلمه کلیدی ضروری است.';
            }

            return isValid;
        }

        function loadBtnLoader() {
            $('.wizard-buttons').append('<div id="btn-spinner" class="d-flex justify-content-center"> <button type="button" disabled="" class="m-2 btn btn-outline-dark">   <span class="spinner-grow spinner-grow-sm" aria-hidden="true"></span>   <span class="visually-hidden" role="status">Loading...</span> </button><button type="button" disabled="" class="m-2 btn btn-outline-primary">   <span class="spinner-grow spinner-grow-sm" aria-hidden="true"></span>   <span class="visually-hidden" role="status">Loading...</span> </button>  </div>')
        }

        function loadResources(reload = false) {
            showLoader('#loading-resources', [
                'در حال دریافت منابع...',
                'در حال پردازش اطلاعات...',
                'لطفا صبور باشید، منابع بیشتری در راهند...',
                'در حال بارگیری منابع...',
                'در حال بررسی منابع در دسترس...'
            ]);

            $("#resource-result").hide();
            $("input[name='search_in_resource']").prop('disabled', true)
            $("#search-resource-btn").prop('disabled', true)

            let request = reload ?
                {
                    "main_topic": $("input[name='search_in_resource']").val(),
                    "language_model": $("input[name='language_model']").val()
                } : {
                    "main_topic": main_tagify.value[0]['value']
                };

            $("input[name='search_in_resource']").val(request.main_topic);


            $("#form-container").find("input, button, textarea, select").prop("disabled", true);
            $('.btn-outline-primary').hide();
            $('.btn-outline-dark').hide();
            loadBtnLoader()
            $.ajax({
                type: 'POST',
                url: "{{ url_for('dashboard.get_resources') }}",
                data: JSON.stringify(request),
                contentType: "application/json",
                processData: false,
                success: function (response) {

                    $("#form-container").find("input, button, textarea, select").prop("disabled", false);
                    $('#btn-spinner').remove()
                    $('.btn-outline-dark').show();
                    $('.btn-outline-primary').show();

                    $("#resource-result").empty();
                    $("#resource-result").show();
                    $.each(response, function (key, value) {
                        let row = `<li class="border border-light-subtle p-2 rounded list-group-item mb-2 p-2" aria-current="true" id="${key}-source" data-key="${key}">
                            <div class="d-flex w-100 justify-content-start">
                                <p class="mb-1 p-2 ">
                                    <a class="link-primary me-2 add-resource"><i class="fa-solid fa-circle-plus"></i></a>
                                    ${value['title']}
                                </p>
                            </div>
                            <p class="mb-1 text-secondary mt-2 small">${value['content']}</p>
                            <div class='w-100 fst-italic' style="direction: ltr; text-align:left;">
                                <small><a class="link-primary mt-2" href="${decodeURIComponent(value['url'])}">${decodeURIComponent(value['url'])}</a></small>
                            </div>
                        </li>`;
                        $("#resource-result").append(row);

                        $("input[name='search_in_resource']").prop('disabled', false)
                        $("#search-resource-btn").prop('disabled', false)

                        $(".loading").hide();
                    });
                },
                error: function (error) {
                    console.log('Error:', error);
                }
            });
        }


        $("#search-resource-btn").click(function () {
            loadResources(true)
        });

        function loadTitles() {
            showLoader('#loading-titles', [
                'در حال دریافت تیترها...',
                'در حال پردازش اطلاعات تیتر...',
                'لطفا صبور باشید، تیترهای بیشتری در دسترسند...',
                'در حال بارگیری تیترهای ممکن...',
                'در حال بررسی بهترین تیترها...'
            ]);

            var request = {
                "user_topic": $("input[name='main_tag']").val(),
                "language_model": $("input[name='language_model']").val(),
                "lang": $('input[name="language"]:checked').val()
            };

            $('.btn-outline-primary').hide();
            $('.btn-outline-dark').hide();
            loadBtnLoader()

            $("#form-container").find("input, button, textarea, select").prop("disabled", true);
            $.ajax({
                type: 'POST',
                url: "{{ url_for('dashboard.get_titles') }}",
                data: JSON.stringify(request),
                contentType: "application/json",
                processData: false,
                success: function (response) {
                    $("#suggest-titles").empty();
                    $('#btn-spinner').remove()

                    $("#form-container").find("input, button, textarea, select").prop("disabled", false);
                    $('.btn-outline-primary').show();
                    $('.btn-outline-dark').show();
                    $('#btn-spinner').remove();

                    $.each(response, function (key, value) {
                        let row = `<li class="list-group-item mt-2 mb-2 p-2 text-bg-light rounded" id="titles-${key}">
                            <input class="form-check-input me-1" required="true" type="radio" name="listGroupRadio" onclick="$('#titles-user-input-radio').prop('checked', false);$('#user-title-input').prop('required', false);" id="titles-checkbox-${key}">
                            <label class="form-check-label" for="titles-checkbox-${key}">${value}</label>
                        </li>`;
                        $("#suggest-titles").append(row);
                    });
                    $("#titles-container").show();
                    $(".loading").hide();
                },
                error: function (error) {
                    console.log('Error:', error);
                }
            });
        }

        function loadOutlines() {
            $("#outlines-container").hide();
            showLoader('#loading-outlines', [
                'در حال دریافت عناوین...',
                'در حال پردازش اطلاعات عناوین...',
                'لطفا صبور باشید، عناوین بیشتری در دسترسند...',
                'در حال بارگیری عناوین ممکن...',
                'در حال بررسی بهترین عناوین...'
            ]);

            let selectedTitle = $("input[name='listGroupRadio']:checked").attr('id') === 'titles-user-input-radio'
                ? $("#user-title-input").val()
                : $("input[name='listGroupRadio']:checked").next('label').text();

            var request = {
                "selected_title": selectedTitle,
                "language_model": $("input[name='language_model']").val(),
                "lang": $('input[name="language"]:checked').val()
            };

            $('.btn-outline-primary').hide();
            $('.btn-outline-dark').hide();
            loadBtnLoader()

            $("#form-container").find("input, button, textarea, select").prop("disabled", true);

            $.ajax({
                type: 'POST',
                url: "{{ url_for('dashboard.get_outlines') }}",
                data: JSON.stringify(request),
                contentType: "application/json",
                processData: false,
                success: function (response) {
                    $("#list-1").empty();
                    $("#list-2").empty();
                    $('#btn-spinner').remove()
                    $('.btn-outline-dark').show();
                    $('.btn-outline-primary').show();

                    $("#form-container").find("input, button, textarea, select").prop("disabled", false);
                    suggested_lists = response;
                    $.each(response, function (index, outlineArray) {
                        let tabContent = index === 0 ? "#list-1" : "#list-2";

                        $.each(outlineArray, function (outlineIndex, outline) {
                            mainOutlineCounter++;
                            let mainOutlineId = `main-outline-${mainOutlineCounter}`;

                            let mainHead = outline.head;
                            let subHeads = outline.subs;
                            let outlineHTML = `<div class="mb-3 outline-item" id="${mainOutlineId}">
                                <div class="d-flex mb-2">
                                    <input type="text" class="form-control main-outline-input" id="${mainOutlineId}-input" value="${mainHead}" />
                                    <button type="button" class="btn btn-link text-danger ms-2 remove-main-outline" id="${mainOutlineId}-remove"><i class="fas fa-minus"></i></button>
                                    <button type="button" class="btn btn-link text-success ms-2 add-sub-outline" id="${mainOutlineId}-add-sub"><i class="fas fa-plus"></i></button>
                                </div>
                                <div class="ms-3 sub-outline-container" id="${mainOutlineId}-subs">`;

                            $.each(subHeads, function (subIndex, subHead) {
                                subOutlineCounter++;
                                let subOutlineId = `sub-outline-${subOutlineCounter}`;
                                outlineHTML += `<div class="d-flex mb-2 sub-outline-item" id="${subOutlineId}">
                                    <input type="text" class="form-control sub-outline-input" id="${subOutlineId}-input" value="${subHead}" />
                                    <button type="button" class="btn btn-link text-danger ms-2 remove-sub-outline" id="${subOutlineId}-remove"><i class="fas fa-minus"></i></button>
                                </div>`;
                            });

                            outlineHTML += `</div></div>`;
                            $(tabContent).append(outlineHTML);
                        });
                        selected_list = response[0];
                    });
                    $("#outlines-container").show();
                    $(".loading").hide();
                    attachEventHandlers();
                },
                error: function (error) {
                    console.log('Error:', error);
                }
            });
        }



        function loadImages(reload = false) {
            showLoader('#loading-images', [
                'در حال بارگذاری تصاویر...',
                'در حال یافتن بهترین تصاویر مرتبط...',
                'لطفا صبور باشید، تصاویر بیشتر در راهند...',
                'در حال دریافت اطلاعات تصاویر...',
                'در حال پردازش تصاویر...'
            ]);

            $("input[name='search_in_resource']").prop('disabled', true);
            $("#search-resource-btn").prop('disabled', true);

            let request = { "main_topic": main_tagify.value[0]['value'], 'list': selected_list };

            $("input[name='search_in_resource']").val(main_tagify.value[0]['value']);
            $("#form-container").find("input, button, textarea, select").prop("disabled", true);
            $('.btn-outline-primary').hide();
            $('.btn-outline-dark').hide();
            loadBtnLoader()
            $.ajax({
                type: 'POST',
                url: "{{ url_for('dashboard.get_images') }}",
                data: JSON.stringify(request),
                contentType: "application/json",
                processData: false,
                success: function (response) {
                    console.log(response)
                },
                error: function (error) {
                    console.log('Error:', error);
                }
            });
        }



        $("#refresh-suggest-titles").click(function () {
            loadTitles()
        });



        $("#user-title-input").click(function () {
            $("#titles-user-input-radio").prop('checked', true)
            $('#user-title-input').prop('required', true);
            for (let i = 0; i <= 5; i++) {
                let selector = `#titles-checkbox-${i}`;
                let element = $(selector);
                element.prop('required', false);

            }
        });


        // Handle click on user-input radio button
        $('#titles-user-input-radio').on('click', function () {
            $('#suggest-titles input[type="radio"]').prop('required', false);
            $('#user-title-input').prop('required', true);
            for (let i = 0; i <= 5; i++) {
                let selector = `#titles-checkbox-${i}`;
                let element = $(selector);
                element.prop('required', false);
            }
        });


        $("#tab-1-tab").click(function () {
            selected_list = suggested_lists[0];
        });
        $("#tab-2-tab").click(function () {
            selected_list = suggested_lists[1];
        });

        function attachEventHandlers() {
            $('.remove-main-outline').off('click').on('click', function () {
                $(this).closest('.outline-item').remove();
            });

            $('.add-sub-outline').off('click').on('click', function () {
                subOutlineCounter++;
                let parentId = $(this).closest('.outline-item').attr('id');
                let subOutlineId = `sub-outline-${subOutlineCounter}`;
                let subOutlineHTML = `<div class="d-flex mb-2 sub-outline-item" id="${subOutlineId}">
                    <input type="text" class="form-control sub-outline-input" id="${subOutlineId}-input" value="" />
                    <button class="btn btn-link text-danger ms-2 remove-sub-outline" type="button" id="${subOutlineId}-remove"><i class="fas fa-minus"></i></button>
                </div>`;
                $(`#${parentId}-subs`).append(subOutlineHTML);
                attachEventHandlers();
            });

            $('.remove-sub-outline').off('click').on('click', function () {
                $(this).closest('.sub-outline-item').remove();
            });

            $('.add-main-outline-btn').off('click').on('click', function () {
                mainOutlineCounter++;
                let listId = $(this).data('list');
                let mainOutlineId = `main-outline-${mainOutlineCounter}`;
                let mainOutlineHTML = `<div class="mb-3 outline-item" id="${mainOutlineId}">
                    <div class="d-flex mb-2">
                        <input type="text" class="form-control main-outline-input" id="${mainOutlineId}-input" value="" />
                        <button type="button" class="btn btn-outline-danger ms-2 remove-main-outline" id="${mainOutlineId}-remove"><i class="fas fa-minus"></i></button>
                        <button type="button" class="btn btn-outline-success ms-2 add-sub-outline" id="${mainOutlineId}-add-sub"><i class="fas fa-plus"></i></button>
                    </div>
                    <div class="ms-3 sub-outline-container" id="${mainOutlineId}-subs"></div>
                </div>`;
                $("#list-" + listId).append(mainOutlineHTML);
                attachEventHandlers();
            });
        }


        function showLoader(loaderId, messages) {
            let currentMessageIndex = 0;

            function displayNextMessage() {
                $(loaderId + ' .loading-text').text(messages[currentMessageIndex]);
                currentMessageIndex = (currentMessageIndex + 1) % messages.length;
            }

            displayNextMessage();
            clearInterval(loaderId + '-interval');
            window.setInterval(displayNextMessage, 5000);

            $(".loading").hide();
            $(loaderId).show();
            $('.btn-prev').prop('disabled', true); // Disable back button
        }

        function hideLoader(loaderId) {
            $(loaderId).hide();
            clearInterval(loaderId + '-interval');
            $('.btn-prev').prop('disabled', false); // Enable back button
        }

        // Delegate event listener to parent element for dynamically added .add-resource elements
        $("#resource-result").on("click", ".add-resource", function () {
            let resourceItem = $(this).closest("li");
            let key = resourceItem.data("key");
            let url = resourceItem.find('a.link-primary').text();
            //let url = resourceItem.find('a.link-primary').attr('href');

            resources.push(['web', url]);
            console.log(url)

            console.log(resources)
            addResource(key, 'web', url);
            resourceItem.remove();
        });


        $('#upload-button').on('click', function (e) {
            e.preventDefault();
            $('#file-upload').click();
        });

        $('#file-upload').on('change', function () {
            if ($("#selected-resources .row").length >= maxSelectedResources) {
                alert('You can select up to ' + maxSelectedResources + ' resources only.');
                return;
            }

            var formData = new FormData();
            var file = $('#file-upload')[0].files[0];
            formData.append('file', file);

            var $uploadButton = $('#upload-button');
            $uploadButton.find('.spinner-border').removeClass('d-none');
            $uploadButton.prop('disabled', true);

            $.ajax({
                url: '{{ url_for("dashboard.upload_resource") }}',
                type: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                success: function (data) {
                    addResource(data.url, 'file', data.url);
                    resources.push(['file', data.url]);
                    console.log(resources)
                    $uploadButton.find('.spinner-border').addClass('d-none');
                    $uploadButton.prop('disabled', false);
                    $('#file-upload').val('');
                },
                error: function (error) {
                    $uploadButton.find('.spinner-border').addClass('d-none');
                    $uploadButton.prop('disabled', false);
                }
            });
        });

        $wz_doc.addEventListener("wz.end", function (e) {
            alert("Wizard End");
        });

        $wz_doc.addEventListener("wz.error", function (e) {
            e.preventDefault();
            console.log(`↓ ID ↓`);
            console.log(e.detail.id);
            console.log(`↓ Message ↓`);
            console.log(e.detail.msg);
        });

        ClassicEditor
            .create(document.querySelector('#text-editor'), {
                language: "fa",
                height: 500
            })
            .then(newEditor => {
                editor = newEditor;
            })
            .catch(error => {
                console.error(error);
            });

        updateResourceCount();

        function checkValidation() {
            let form = $("#form")[0];

            if (form) {
                let isFormValid = form.checkValidity();
                $(".wizard .btn-next").prop("disabled", !isFormValid);
            }
        }

        // Finish button click handler
        $(".finish-button").on("click", function (e) {
            e.preventDefault();

            // Gather data from all steps
            const userTopic = $("#form_user_topic").val();
            const mainTag = main_tagify.value[0]['value'];
            const tags = tagify.value.map(tag => tag.value);

            let selectedTitle = $("input[name='listGroupRadio']:checked").attr('id') === 'titles-user-input-radio'
                ? $("#user-title-input").val()
                : $("input[name='listGroupRadio']:checked").next('label').text();

            const selectedResources = [];
            $("#selected-resources .row").each(function () {
                const resourceType = $(this).find(".badge").hasClass("text-bg-secondary") ? "file" : "web";
                const resourceUrl = $(this).find("a.link-primary").attr("href");
                selectedResources.push({ type: resourceType, url: resourceUrl });
            });

            const requestData = {
                user_topic: userTopic,
                main_tag: mainTag,
                language_model: $("input[name='language_model']").val(),
                tags: tags,
                point_ofview: $("#point_ofview").val(),
                target_audience: $("#target_audience").val(),
                voice_tune: $("#voice_tune").val(),
                article_length: $("#article_length").val(),
                lang: $('input[name="language"]:checked').val(),
                selected_resources: selectedResources,
                selected_title: selectedTitle,
                outlines: selected_list,
                content_type: 1
            };
            //console.log(requestData)
            console.log(requestData)

            $.ajax({
                type: 'POST',
                url: "{{ url_for('dashboard.create_article_pro') }}",
                data: JSON.stringify(requestData),
                contentType: "application/json",
                processData: false,
                success: function (data) {
                    // alert("Successfully submitted!");
                    $('#form-container').hide()
                    $('#content-container').show()
                    $('#loading-content').show()
                    $('#article-container-timer').show()
                    const jobId = data.job_id;
                    const contentId = data.content_id;

                    startTimer()
                    checkJobStatus(jobId, contentId);
                },
                error: function (error) {
                    console.error("Submission error:", error);
                }
            });
        });


        $("#form input, #form select").on("change input", checkValidation);

        checkValidation();

        attachEventHandlers();
    });
</script>
{% endblock %}