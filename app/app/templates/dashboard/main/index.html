{% extends "dashboard/dashboard.html" %}
{% block dashboard %}

{% if contents %}
<style>
  #listing-table tbody td:hover {
    cursor: pointer;
  }
</style>
<div class="dashboard-card d-flex flex-md-column align-items-start justify-content-start p-4" style="min-height: 65vh;">
  <table class="table table-hover" id="listing-table">
    <thead class="table-parimary">
      <tr>
        <td class="text-center p-4">عنوان</td>
        <td class="text-center p-4">کلمات</td>
        <td class="text-center p-4">نوع محتوا</td>
        <td class="text-center p-4">تاریخ</td>
        <td class="text-center p-4"></td>
        <td class="text-center p-4"></td>
      </tr>
    </thead>
    <tbody class="table-group-divider">
      {% for content in contents %}
      <tr>
        <td class="text-center p-4" onclick="openContent('{{ content.content_type }}', '{{ content.id }}')" id="
          title-content-{{ content.id }}">
          {% if content.system_title %}
          {{ content.system_title | safe }}
          {% else %}
          <span class="status-{{ content.id }}"></span>
          {% endif %}
        </td>
        <td class="text-center p-4" id="
        title-content-{{ content.id }}">
          {% if content.word_count %}
          {{ content.word_count | safe }}
          {% else %}
          <span class="status-{{ content.id }}"></span>
          {% endif %}
        </td>
        <td class="text-center p-4">{{ content.content_type | show_content_type }}</td>
        <td class="text-center p-4">{{ content.timestamp | gregorian_to_jalali }}</td>
        <td class="text-center p-4">
          <span class="status-{{ content.id }}"></span>
        </td>
        <td class="text-center p-4">
          <div class="dropdown">
            <button class="btn btn-link dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
            </button>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#"
                  onclick="openContent('{{ content.content_type }}', '{{ content.id }}')">
                  <i class="fa-solid fa-pen me-2"></i>
                  ویرایش
                </a></li>
              <li><a class="dropdown-item" href="#">
                  <i class="fa-solid fa-trash  me-2"></i>
                  حذف
                </a></li>
            </ul>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <nav aria-label="Page navigation">
    <ul class="pagination justify-content-center">
      {% if prev_url %}
      <li class="page-item">
        <a class="page-link" href="{{ prev_url }}">قبلی</a>
      </li>
      {% endif %}
      {% if next_url %}
      <li class="page-item">
        <a class="page-link" href="{{ next_url }}">بعدی</a>
      </li>
      {% endif %}
    </ul>
  </nav>
</div>

{% else %}
<div class="dashboard-card d-flex flex-md-column align-items-start justify-content-start p-4">
  <div id="dashboard-content" class="w-100 d-flex flex-column justify-content-center" style="min-height: 65vh;">
    <div class="d-flex justify-content-center align-items-center flex-grow-1" style="min-height: 65vh;">
      <span class="p-4 rounded bg-light text-dark text-center align-bottom border-1" style="width: 300px;">هنوز محتوایی
        تولید نکرده‌اید</span>
    </div>
  </div>
</div>
{% endif %}

<script src="{{ url_for('static', filename='js/jquery.js') }}"></script>

<script>
  function openContent(contentType, contentId) {
    let url;
    switch (contentType) {
      case '0':
        url = "{{ url_for('dashboard.article_blog', id='') }}" + contentId;
        break;
      case '1':
        url = "{{ url_for('dashboard.article', id='') }}" + contentId;
        break;
      case '2':
      default:
        url = "{{ url_for('dashboard.article_pro', id='') }}" + contentId;
        break;
    }
    window.location.href = url;
  }

  $(document).ready(function () {
    // Function to check job status
    function checkJobStatus(jobId, contentId) {
      console.log(`Checking job status for jobId: ${jobId}, contentId: ${contentId}`);
      $.get(`/dashboard/article/blog/status/${jobId}`, function (data) {
        if (data.status === 'SUCCESS') {
          $(`.status-${contentId}`).html('<i class="fa fa-check text-success"></i>');
          $.get(`/dashboard/article/blog/content/${contentId}`, function (data) {
            $(`.title-content-${contentId}`).html(data.system_title);
            $(`.wc-content-${contentId}`).html(data.word_count);
          });
        } else {
          $(`.status-${contentId}`).html('<i class="fa fa-spinner fa-spin text-parimary"></i>');
          setTimeout(() => checkJobStatus(jobId, contentId), 2000);
        }
      }).fail(function (xhr, status, error) {
        console.error(`Error checking job status for jobId ${jobId}:`, error);
      });
    }

    {% for content in contents %}
    checkJobStatus('{{ content.job_id }}', '{{ content.id }}');
    {% endfor %}
  });
</script>
{% endblock %}